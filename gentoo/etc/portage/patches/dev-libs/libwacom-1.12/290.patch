From df8898e71c24f0e757a16fcb09df10c2d796401a Mon Sep 17 00:00:00 2001
From: Peter Hutterer <peter.hutterer@who-t.net>
Date: Thu, 7 Oct 2021 08:09:42 +1000
Subject: [PATCH 1/2] meson.build: bump minimum version to 0.51

This allows us to get rid of one conditional, and 0.51 is over two years
old by now anyway.
---
 meson.build | 6 ++----
 1 file changed, 2 insertions(+), 4 deletions(-)

diff --git a/meson.build b/meson.build
index 1670c630..66fe96c2 100644
--- a/meson.build
+++ b/meson.build
@@ -2,7 +2,7 @@ project('libwacom', 'c',
 	version: '1.12', # change configure.ac as well
 	license: 'MIT/Expat',
 	default_options: [ 'c_std=gnu99', 'warning_level=2' ],
-	meson_version: '>= 0.50.0')
+	meson_version: '>= 0.51.0')
 
 dir_bin     = get_option('prefix') / get_option('bindir')
 dir_data    = get_option('prefix') / get_option('datadir') / 'libwacom'
@@ -302,9 +302,7 @@ if get_option('tests').enabled()
 		     suite: ['all'])
 	endif
 
-	if meson.version().version_compare('>= 0.51.0')
-		pymod.find_installation(modules: ['libevdev', 'pyudev', 'pytest'])
-	endif
+	pymod.find_installation(modules: ['libevdev', 'pyudev', 'pytest'])
 	pytest = find_program('pytest-3', 'pytest')
 	test('pytest',
 	     pytest,

From 71c9f65367c2092f2687693ccc61a16990181e24 Mon Sep 17 00:00:00 2001
From: Peter Hutterer <peter.hutterer@who-t.net>
Date: Tue, 15 Sep 2020 10:43:35 +1000
Subject: [PATCH 2/2] Bump the soname to get rid of the deprecated symbols

This is an ABI break but doesn't have any effect on any caller, just rebuild
the caller and done. None of these symbols were ever used by anyone (see
d918631fe65594b62283980beef5a14e7f744b97), keeping them was nice for ABI
stability but it also causes some issues, notably with compilers not
supporting symbol versioning.

The new exported symbol set is already named libwacom 2.0. Still the same API
but it makes for less surprises of those using the API.

Fixes https://github.com/linuxwacom/libwacom/issues/192
Fixes https://github.com/linuxwacom/libwacom/issues/170
Fixes https://github.com/linuxwacom/libwacom/issues/267

Signed-off-by: Peter Hutterer <peter.hutterer@who-t.net>
---
 configure.ac                   |  2 +-
 libwacom/Makefile.am           |  2 +-
 libwacom/libwacom-deprecated.c | 84 ----------------------------------
 libwacom/libwacom.sym          | 15 ++----
 meson.build                    | 23 ++--------
 test/Makefile.am               |  1 -
 test/test-ltversion.c          |  6 +--
 7 files changed, 11 insertions(+), 122 deletions(-)
 delete mode 100644 libwacom/libwacom-deprecated.c

diff --git a/configure.ac b/configure.ac
index 3f756678..b9ccf17f 100644
--- a/configure.ac
+++ b/configure.ac
@@ -11,7 +11,7 @@ AM_MAINTAINER_MODE([enable])
 m4_ifdef([AM_SILENT_RULES],[AM_SILENT_RULES([yes])])
 
 # Do not modify this, use symbol versioning instead.
-LIBWACOM_LT_VERSION=8:1:6
+LIBWACOM_LT_VERSION=9:0:0
 AC_SUBST(LIBWACOM_LT_VERSION)
 
 # Initialize libtool
diff --git a/libwacom/Makefile.am b/libwacom/Makefile.am
index 372b87cf..b6b18ec5 100644
--- a/libwacom/Makefile.am
+++ b/libwacom/Makefile.am
@@ -15,7 +15,7 @@ libwacom_la_SOURCES = \
                       libwacom.c \
                       libwacom-error.c \
                       libwacom-database.c \
-                      libwacom-deprecated.c
+                      $(NULL)
 
 libwacom_la_LIBADD = $(GLIB_LIBS)
 libwacom_la_CFLAGS = $(AM_CPPFLAGS) $(GLIB_CFLAGS)
diff --git a/libwacom/libwacom-deprecated.c b/libwacom/libwacom-deprecated.c
deleted file mode 100644
index dcbe4699..00000000
--- a/libwacom/libwacom-deprecated.c
+++ /dev/null
@@ -1,84 +0,0 @@
-/*
- * Copyright Â© 2019 Red Hat, Inc.
- *
- * Permission to use, copy, modify, distribute, and sell this software
- * and its documentation for any purpose is hereby granted without
- * fee, provided that the above copyright notice appear in all copies
- * and that both that copyright notice and this permission notice
- * appear in supporting documentation, and that the name of Red Hat
- * not be used in advertising or publicity pertaining to distribution
- * of the software without specific, written prior permission.  Red
- * Hat makes no representations about the suitability of this software
- * for any purpose.  It is provided "as is" without express or implied
- * warranty.
- *
- * THE AUTHORS DISCLAIM ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,
- * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN
- * NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY SPECIAL, INDIRECT OR
- * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS
- * OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
- * NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
- * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
- *
- */
-
-#include "config.h"
-
-#define _GNU_SOURCE
-#include <stdio.h>
-#include <libwacom.h>
-
-/* Deprecated symbols. Up to including libwacom 0.33, these symbols ended up
- * in the public ABI.But not the API, the declarations were always in an
- * internal header only.
- *
- * All of these have no use for the caller and in some cases only serve to
- * corrupt memory if the caller actually invokes them. There aren't any
- * legitimate users out there, but let's be safe anyway. For backwards
- * compatibility, we create noop functions for those and alias
- * them to the previously exposed public symbols.
- *
- * If the soname is ever bumped for an incompatible change, we can remove
- * all these.
- */
-#define LIBWACOM_EXPORT __attribute__ ((visibility("default")))
-
-void _match_destroy(WacomMatch *match);
-WacomMatch* _match_new(const char *name, WacomBusType bus,
-                       int vendor_id, int product_id);
-void _error_set(WacomError *error, enum WacomErrorCode code,
-                const char *msg, ...);
-void _stylus_destroy(WacomStylus *stylus);
-void _update_match(WacomDevice *device, const WacomMatch *match);
-
-LIBWACOM_EXPORT void
-_match_destroy(WacomMatch *match)
-{
-}
-asm(".symver _match_destroy,libwacom_match_destroy@LIBWACOM_0.33");
-
-
-LIBWACOM_EXPORT WacomMatch*
-_match_new(const char *name, WacomBusType bus, int vendor_id, int product_id)
-{
-	return NULL;
-}
-asm(".symver _match_new,libwacom_match_new@LIBWACOM_0.33");
-
-LIBWACOM_EXPORT void
-_error_set(WacomError *error, enum WacomErrorCode code, const char *msg, ...)
-{
-}
-asm(".symver _error_set,libwacom_error_set@LIBWACOM_0.33");
-
-LIBWACOM_EXPORT void
-_stylus_destroy(WacomStylus *stylus)
-{
-}
-asm(".symver _stylus_destroy,libwacom_stylus_destroy@LIBWACOM_0.33");
-
-LIBWACOM_EXPORT void
-_update_match(WacomDevice *device, const WacomMatch *newmatch)
-{
-}
-asm(".symver _update_match,libwacom_update_match@LIBWACOM_0.33");
diff --git a/libwacom/libwacom.sym b/libwacom/libwacom.sym
index ae859f8e..e517f2de 100644
--- a/libwacom/libwacom.sym
+++ b/libwacom/libwacom.sym
@@ -1,6 +1,6 @@
 /* in alphabetical order! */
 
-LIBWACOM_0.33 {
+LIBWACOM_2.0 {
 global:
     libwacom_compare;
     libwacom_database_destroy;
@@ -11,7 +11,6 @@ global:
     libwacom_error_get_code;
     libwacom_error_get_message;
     libwacom_error_new;
-    libwacom_error_set;
     libwacom_get_bustype;
     libwacom_get_button_evdev_code;
     libwacom_get_button_flag;
@@ -43,37 +42,29 @@ global:
     libwacom_is_builtin;
     libwacom_is_reversible;
     libwacom_list_devices_from_database;
-    libwacom_match_destroy;
     libwacom_match_get_bustype;
     libwacom_match_get_match_string;
     libwacom_match_get_name;
     libwacom_match_get_product_id;
     libwacom_match_get_vendor_id;
-    libwacom_match_new;
     libwacom_new_from_name;
     libwacom_new_from_path;
     libwacom_new_from_usbid;
     libwacom_print_device_description;
     libwacom_print_stylus_description;
-    libwacom_stylus_destroy;
     libwacom_stylus_get_axes;
+    libwacom_stylus_get_eraser_type;
     libwacom_stylus_get_for_id;
     libwacom_stylus_get_id;
     libwacom_stylus_get_name;
     libwacom_stylus_get_num_buttons;
+    libwacom_stylus_get_paired_ids;
     libwacom_stylus_get_type;
     libwacom_stylus_has_eraser;
     libwacom_stylus_has_lens;
     libwacom_stylus_has_wheel;
     libwacom_stylus_is_eraser;
-    libwacom_update_match;
 
 local:
         *;
 };
-
-LIBWACOM_1.4 {
-global:
-    libwacom_stylus_get_eraser_type;
-    libwacom_stylus_get_paired_ids;
-} LIBWACOM_0.33;
diff --git a/meson.build b/meson.build
index 66fe96c2..912f7478 100644
--- a/meson.build
+++ b/meson.build
@@ -21,9 +21,9 @@ pymod = import('python')
 python = pymod.find_installation('python3', required: true)
 
 # Do not modify this, use symbol versioning instead.
-libwacom_lt_c=8
-libwacom_lt_r=1
-libwacom_lt_a=6
+libwacom_lt_c=9
+libwacom_lt_r=0
+libwacom_lt_a=0
 # convert ltversion to soname
 libwacom_so_version = '@0@.@1@.@2@'.format((libwacom_lt_c - libwacom_lt_a),
                                             libwacom_lt_a, libwacom_lt_r)
@@ -71,7 +71,6 @@ src_libwacom = [
 	'libwacom/libwacom.c',
 	'libwacom/libwacom-error.c',
 	'libwacom/libwacom-database.c',
-	'libwacom/libwacom-deprecated.c',
 ]
 
 deps_libwacom = [
@@ -286,22 +285,6 @@ if get_option('tests').enabled()
 		message('valgrind not found, disabling valgrind test suite')
 	endif
 
-	# because of the tricks we use in calling the function and exposing
-	# it to begin with, LTO gets confused and this fails to link.
-	# Let's just disable it here.
-	if not get_option('b_lto')
-		test_deprecated = executable('test-deprecated',
-					     'test/test-deprecated.c',
-					     dependencies: [dep_libwacom, dep_dl],
-					     include_directories: [includes_src],
-					     c_args: tests_cflags,
-					     install: false)
-		test('test-deprecated',
-		     test_deprecated,
-		     env:['LD_LIBRARY_PATH=@0@'.format(meson.build_root())],
-		     suite: ['all'])
-	endif
-
 	pymod.find_installation(modules: ['libevdev', 'pyudev', 'pytest'])
 	pytest = find_program('pytest-3', 'pytest')
 	test('pytest',
diff --git a/test/Makefile.am b/test/Makefile.am
index 24e7453e..afbf10ba 100644
--- a/test/Makefile.am
+++ b/test/Makefile.am
@@ -4,7 +4,6 @@ noinst_PROGRAMS= \
 		 test-tablet-validity \
 		 test-stylus-validity \
 		 test-ltversion \
-		 test-deprecated \
 		 $(NULL)
 
 TESTS=$(noinst_PROGRAMS)
diff --git a/test/test-ltversion.c b/test/test-ltversion.c
index c7c632ad..cb07dd59 100644
--- a/test/test-ltversion.c
+++ b/test/test-ltversion.c
@@ -12,9 +12,9 @@ int main(void) {
         /* we don't change the soname anymore, we use symbol maps instead.
            So these can stay fixed until we properly break the ABI and bump
            the soname.  */
-	assert(C == 8);
-	assert(R == 1);
-	assert(A == 6);
+	assert(C == 9);
+	assert(R == 0);
+	assert(A == 0);
 
 	return 0;
 }
